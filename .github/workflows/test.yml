name: Go Test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Check out code
        uses: actions/checkout@v3

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: './go.mod'

      - name: Get dependencies
        run: go mod tidy

      - name: Vendor dependencies
        run: go mod vendor

      - name: Build Shared Library
        if: success()
        run: |
          make arm-build

      - name: Install UPX
        if: success()
        run: |
          sudo apt-get update
          sudo apt-get install -y upx

      - name: Compress binary with UPX
        if: success()
        run: |
          upx --best --lzma ./dns-box

      - name: Install GitHub CLI
        if: success()
        run: |
          sudo apt-get install -y gh

      - name: Authenticate GitHub CLI
        if: success()
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token
          gh auth status

      - name: Get Latest Release Tag and Increment
        run: |
          LATEST_TAG=$(gh release list --limit 1 --json tagName --jq '.[0].tagName')
          
          if [[ -z "$LATEST_TAG" ]]; then
            NEW_TAG="v1.0.0"
          else
            MAJOR=$(echo "$LATEST_TAG" | cut -d. -f1 | tr -d 'v')
            MINOR=$(echo "$LATEST_TAG" | cut -d. -f2)
            PATCH=$(echo "$LATEST_TAG" | cut -d. -f3)
            PATCH=$((PATCH + 1))
            NEW_TAG="v${MAJOR}.${MINOR}.${PATCH}"
          fi
          
          COMMIT_HASH=$(git rev-parse --short HEAD)
          
          gh release create "$NEW_TAG" \
            ./dns-box \
            --title "$NEW_TAG" \
            --notes "Release created from commit $COMMIT_HASH. This release was automatically generated by GitHub Actions."
